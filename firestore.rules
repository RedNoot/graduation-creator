rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is an editor of a graduation
    function isEditor(graduationId) {
      let gradData = get(/databases/$(database)/documents/graduations/$(graduationId)).data;
      return request.auth != null && 
             (request.auth.uid in gradData.editors ||
              (gradData.ownerUid != null && request.auth.uid == gradData.ownerUid));
    }
    
    // Graduation documents
    match /graduations/{gradId} {
      // Allow read if user is an editor (with backwards compatibility for ownerUid)
      allow read: if request.auth != null && 
                     (request.auth.uid in resource.data.editors ||
                      (resource.data.ownerUid != null && request.auth.uid == resource.data.ownerUid));
      
      // Allow create if authenticated (user will be added to editors array)
      allow create: if request.auth != null &&
                       request.auth.uid in request.resource.data.editors &&
                       request.resource.data.editors.size() >= 1;
      
      // Allow update if user is an editor (with backwards compatibility for ownerUid)
      allow update: if request.auth != null && 
                       (request.auth.uid in resource.data.editors ||
                        (resource.data.ownerUid != null && request.auth.uid == resource.data.ownerUid)) &&
                       // Ensure at least one editor remains (if editors array exists)
                       (!request.resource.data.keys().hasAny(['editors']) || request.resource.data.editors.size() >= 1) &&
                       // Prevent modification of createdBy field (immutable)
                       (!request.resource.data.keys().hasAny(['createdBy']) || 
                        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['createdBy']));
      
      // Allow delete if user is an editor (with backwards compatibility for ownerUid)
      allow delete: if request.auth != null && 
                       (request.auth.uid in resource.data.editors ||
                        (resource.data.ownerUid != null && request.auth.uid == resource.data.ownerUid));
      
      // Students subcollection
      match /students/{studentId} {
        // Allow read/write if user is an editor of the parent graduation
        allow read, write: if isEditor(gradId);
      }
      
      // Content pages subcollection
      match /contentPages/{pageId} {
        // Allow read/write if user is an editor of the parent graduation
        allow read, write: if isEditor(gradId);
      }
    }
    
    // Public read access for specific routes (like student upload portals)
    // These are handled separately by the application logic
  }
}
