<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 6 Graduation Website Creator</title>
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <!-- Security headers are handled by Netlify configuration -->
    
    <!-- Tailwind CSS CDN - Note: For production, consider installing as PostCSS plugin -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Custom styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="min-h-screen">
        <!-- Main application content will be rendered here -->
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import extracted modules
        import { getConfig, firebaseConfig, CLOUDINARY_CLOUD_NAME, CLOUDINARY_UPLOAD_PRESET, CLOUDINARY_URL } from './js/config.js';
        import { sanitizeInput } from './js/utils/sanitize.js';
        import { copyToClipboard } from './js/utils/clipboard.js';
        import { rateLimiter } from './js/utils/rate-limiter.js';
        import { ensurePublicPdfUrl } from './js/utils/url-helpers.js';
        
        // Import services
        import { app, auth, db } from './js/firebase-init.js';
        import { verifyStudentPassword, signUp, signIn, signOut as authSignOut } from './js/services/auth.js';
        import { uploadFile, getDownloadUrl, showUploadModal } from './js/services/cloudinary.js';
        import { generateBooklet, viewStudentPdf, closeStudentPdfModal } from './js/services/pdf-service.js';
        import * as firestoreService from './js/services/firestore.js';
        
        // Import components
        import { showModal, closeModal, showErrorModal, showSuccessModal, showConfirmModal, showLoadingModal } from './js/components/modal.js';
        import { renderHeader, renderLoading, renderPageLayout } from './js/components/layout.js';
        import { renderLoginPage as renderLoginPageComponent, renderNewGraduationForm as renderNewGraduationFormComponent, renderInputField, renderTextareaField, renderCheckboxField } from './js/components/forms.js';
        import { renderTabNav, renderTabContent, setupTabListeners, renderButtonGroup } from './js/components/tabs.js';
        import { renderStudentCard, renderStudentGrid, renderContentCard, renderContentList, renderList } from './js/components/cards.js';
        
        // Import router and navigation
        import { parseRoute, generateRoute, getFullRouteUrl, ROUTES, ROUTE_METADATA } from './js/router/routes.js';
        import { navigateTo, goToDashboard, goToEditGraduation, goToNewGraduation, goToPublicView, goToUploadPortal, goToDirectUpload, getPublicShareUrl, getUploadPortalUrl, getDirectUploadUrl, getCurrentHash, getBaseUrl, isPublicRoute } from './js/router/navigation.js';
        import { createRouter, createPublicRouter } from './js/router/router.js';
        
        // Import event handlers
        import { setupAuthToggleHandler, setupAuthSubmitHandler, setupLogoutHandler, setupCreateNewHandler, setupNewGraduationFormHandler, setupCancelHandler } from './js/handlers/auth-handlers.js';
        import { setupAddStudentFormHandler, setupCopyGeneralUrlHandler, deleteStudent, uploadPdfForStudent, removePdfForStudent } from './js/handlers/student-handlers.js';
        import { setupAddContentHandler, setupCancelContentHandler, setupContentFormHandler, editContentPage, deleteContentPage, setupPageOrderHandlers } from './js/handlers/content-handlers.js';
        import { setupTabHandlers, setupDownloadSchedulingHandler, setupSettingsFormHandler } from './js/handlers/ui-handlers.js';
        
        // Import data repositories (data access layer)
        import { GraduationRepository } from './js/data/graduation-repository.js';
        import { StudentRepository } from './js/data/student-repository.js';
        import { ContentRepository } from './js/data/content-repository.js';
        
        // Import Firebase auth state listener and functions
        import { onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const config = getConfig();

        const appContainer = document.getElementById('app');
        let currentUser = null;
        // currentGraduationListener is now created in router setup

        // --- UTILITY & HELPER FUNCTIONS ---
        
        // Secure password operations are now handled server-side
        // This function calls the serverless function for password verification
        // Password verification is now imported from js/services/auth.js

        // Input sanitization is now imported from js/utils/sanitize.js

        // PDF upload for teachers and PDF management functions are now imported from services

        // Make PDF service functions available globally for onclick handlers
        window.viewStudentPdf = viewStudentPdf;
        window.closeStudentPdfModal = closeStudentPdfModal;

        // File upload is now imported from js/services/cloudinary.js

        // PDF booklet generation is now handled by js/services/pdf-service.js
        // This wrapper calls the service and handles the UI updates specific to this app
        const generateBookletWithUI = async (graduationId) => {
            showModal('Processing...', 'Generating PDF booklet. This may take a moment...', false);
            
            try {
                // Call the imported service function
                await generateBooklet(graduationId, 
                    // Success callback
                    async (result) => {
                        // Fetch fresh graduation data with the new booklet URL
                        const freshGradData = await GraduationRepository.getById(graduationId);
                        if (freshGradData) {
                            console.log('Fresh URL from Firestore after generation:', freshGradData.generatedBookletUrl);
                            
                            // Update the local state with the new booklet URL
                            showModal(
                                'Success!', 
                                `PDF booklet generated successfully! Contains ${result.pageCount} pages from ${result.studentCount} students. You can download it from the Booklet tab.`
                            );
                            
                            // Reload the booklet tab to show the new download link
                            if (document.querySelector('[data-tab="booklet"]')) {
                                renderBookletTab(graduationId, freshGradData);
                            }
                        }
                    },
                    // Error callback
                    (errorMessage) => {
                        showModal('Error', errorMessage);
                    }
                );
            } catch (error) {
                console.error("PDF Generation Error:", error);
                showModal('Error', 'Failed to generate booklet. Please try again.');
            }
        };


        // --- UI RENDERING FUNCTIONS ---
        
        // Layout rendering functions are now imported from js/components/layout.js

        const renderLoginPageWithListeners = () => {
            appContainer.innerHTML = renderLoginPageComponent();
            
            // Get DOM elements
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            const toggleAuthBtn = document.getElementById('toggle-auth-btn');
            const authSubtitle = document.getElementById('auth-subtitle');
            const toggleText = document.getElementById('toggle-text');
            const passwordHint = document.getElementById('password-hint');
            
            // State object for auth mode
            const authState = { isSignUpMode: false, auth };
            
            // Setup auth handlers with Firebase auth functions
            setupAuthToggleHandler(toggleAuthBtn, authSubmitBtn, toggleText, authSubtitle, passwordHint, authState);
            setupAuthSubmitHandler(authSubmitBtn, { 
                createUserWithEmailAndPassword, 
                signInWithEmailAndPassword 
            }, authState);
            
            console.log('Login page handlers attached!');
        };
        
        const renderDashboard = async () => {
            const header = renderHeader("Your Graduations");
            let mainContent = `
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">Your Projects</h2>
                        <button id="create-new-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Create New Graduation</button>
                    </div>
                    <div id="graduations-list" class="bg-white shadow overflow-hidden sm:rounded-md">
                        <div class="p-8 text-center text-gray-500">Loading projects...</div>
                    </div>
                </div>
            `;
            appContainer.innerHTML = header + `<main>${mainContent}</main>`;

            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('create-new-btn').addEventListener('click', () => {
                 goToNewGraduation();
            });

            // Fetch and display graduations using repository
            const graduations = await GraduationRepository.getByOwner(currentUser.uid);
            const listContainer = document.getElementById('graduations-list');
            if (graduations.length === 0) {
                listContainer.innerHTML = `<div class="p-8 text-center text-gray-500">You haven't created any graduation websites yet.</div>`;
            } else {
                let html = '<ul>';
                graduations.forEach(grad => {
                    html += `
                        <li class="border-t border-gray-200">
                            <a href="#/edit/${grad.id}" class="block hover:bg-gray-50">
                                <div class="px-4 py-4 sm:px-6">
                                    <div class="flex items-center justify-between">
                                        <p class="text-lg font-medium text-indigo-600 truncate">${grad.schoolName || 'Untitled Project'}</p>
                                        <p class="ml-2 flex-shrink-0 text-sm text-gray-500">${grad.graduationYear || ''}</p>
                                    </div>
                                </div>
                            </a>
                        </li>
                    `;
                });
                html += '</ul>';
                listContainer.innerHTML = html;
            }
        };

        const renderNewGraduationForm = () => {
             const header = renderHeader("Create New Graduation");
             let mainContent = `
                <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white p-8 rounded-lg shadow">
                         <form id="new-grad-form">
                            <div class="space-y-6">
                                <div>
                                    <label for="schoolName" class="block text-sm font-medium text-gray-700">School Name</label>
                                    <input type="text" id="schoolName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="graduationYear" class="block text-sm font-medium text-gray-700">Graduation Year</label>
                                    <input type="number" id="graduationYear" required value="${new Date().getFullYear()}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div class="flex justify-end gap-4">
                                    <button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Create</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
             `;
             appContainer.innerHTML = header + `<main>${mainContent}</main>`;

             document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
             document.getElementById('cancel-btn').addEventListener('click', () => goToDashboard());
             document.getElementById('new-grad-form').addEventListener('submit', async (e) => {
                 e.preventDefault();
                 const schoolNameInput = document.getElementById('schoolName').value;
                 const graduationYearInput = document.getElementById('graduationYear').value;
                 
                 // Input validation and sanitization
                 const schoolName = sanitizeInput(schoolNameInput, 'text');
                 const graduationYear = parseInt(graduationYearInput);
                 
                 if (!schoolName || schoolName.length < 2) {
                     showModal('Error', 'Please enter a valid school name (at least 2 characters).');
                     return;
                 }
                 
                 if (!graduationYear || graduationYear < 2000 || graduationYear > 2050) {
                     showModal('Error', 'Please enter a valid graduation year between 2000 and 2050.');
                     return;
                 }

                 // Rate limiting for graduation creation
                 const rateLimitKey = `create-grad-${currentUser.uid}`;
                 if (!rateLimiter.isAllowed(rateLimitKey, 5, 300000)) { // 5 creations per 5 minutes
                     showModal('Rate Limit', 'Too many graduation projects created. Please wait 5 minutes before creating another.');
                     return;
                 }
                 
                 try {
                    showModal('Creating...', 'Setting up your graduation project.', false);
                    
                    const newGrad = await GraduationRepository.create({
                        schoolName,
                        graduationYear: graduationYear,
                        ownerUid: currentUser.uid,
                        createdBy: currentUser.uid, // Add this field for Firestore rules
                        isLocked: false,
                        generatedBookletUrl: null,
                        createdAt: new Date(),
                    });
                    
                    // Create default config subcollection
                    await GraduationRepository.updateConfig(newGrad.id, {
                        // Basic settings
                        schoolLogoUrl: null,
                        primaryColor: "#4f46e5", // indigo-600
                        font: "Inter",
                        layout: "grid",
                        showSpeeches: true,
                        showMessages: true,
                        pageOrder: ["students", "messages", "speeches"],
                        
                        // Advanced theme settings
                        secondaryColor: "#6B7280", // gray-500
                        backgroundColor: "#F9FAFB", // gray-50
                        cardStyle: "shadow",
                        borderRadius: "medium",
                        headerStyle: "centered",
                        animationStyle: "fade",
                        
                        // Download scheduling
                        enableDownloadScheduling: false,
                        downloadableAfterDate: null,
                        downloadMessage: null,
                        
                        // Metadata
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });

                    goToEditGraduation(newGrad.id);
                 } catch (error) {
                     console.error("Error creating graduation:", error);
                     showModal('Error', 'Could not create the project.');
                 }
             });
        };

        const renderEditor = (gradData, gradId) => {
            const header = renderHeader(gradData.schoolName);
            const publicUrl = `${window.location.origin}${window.location.pathname}#/view/${gradId}`;
            
            const mainContent = `
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <!-- TABS -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <a href="#" class="tab-link border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="students">Students</a>
                            <a href="#" class="tab-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="content">Content Pages</a>
                            <a href="#" class="tab-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="settings">Settings</a>
                            <a href="#" class="tab-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="share">Share & View</a>
                            <a href="#" class="tab-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="booklet">Booklet</a>
                        </nav>
                    </div>

                    <!-- TAB CONTENT -->
                    <div id="tab-content">
                        <!-- Content will be injected here -->
                    </div>
                </div>
            `;
            appContainer.innerHTML = header + `<main>${mainContent}</main>`;
            
            // Initial tab load
            renderStudentsTab(gradId);

            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

            // Tab switching logic
            const tabs = document.querySelectorAll('.tab-link');
            
            // Setup tab handlers
            setupTabHandlers(tabs, {
                renderStudentsTab,
                renderContentPagesTab,
                renderSettingsTab,
                renderShareTab,
                renderBookletTab
            }, {
                gradId,
                gradData
            });
        };

        const renderStudentsTab = async (gradId) => {
            const contentContainer = document.getElementById('tab-content');
            contentContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Manage Students</h3>
                    <form id="add-student-form" class="flex gap-4 mb-6 items-end">
                        <div class="flex-grow">
                            <label for="student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                            <input type="text" id="student-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="access-type" class="block text-sm font-medium text-gray-700">Access Method</label>
                            <select id="access-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="public">Public (Select from list)</option>
                                <option value="link">Unique Link (Secure)</option>
                                <option value="password">Password (Secure)</option>
                            </select>
                        </div>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md h-fit">Add Student</button>
                    </form>
                    
                    <!-- General Upload Link for Public/Password Students -->
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="text-md font-medium text-blue-900 mb-2">General Student Upload Link</h4>
                        <p class="text-sm text-blue-700 mb-3">Share this link with students who use public or password access:</p>
                        <div class="flex rounded-md shadow-sm mb-2">
                            <input type="text" readonly id="general-upload-url" value="${window.location.origin}${window.location.pathname}#/upload/${gradId}" class="flex-1 block w-full rounded-none rounded-l-md sm:text-sm border-gray-300 bg-white p-2 text-blue-800">
                            <button id="copy-general-url-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm hover:bg-gray-100">Copy</button>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-xs text-blue-600">Students will select their name and enter password if required</p>
                            <a href="${window.location.origin}${window.location.pathname}#/upload/${gradId}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800 underline">→ Test link</a>
                        </div>
                    </div>
                    
                    <div id="student-list-container">Loading...</div>
                </div>
            `;

            const studentListContainer = document.getElementById('student-list-container');
            
            // Use repository to get real-time updates
            StudentRepository.onUpdate(gradId, (snapshot) => {
                if (snapshot.empty) {
                    studentListContainer.innerHTML = `<p class="text-gray-500">No students added yet.</p>`;
                    return;
                }
                let html = `<ul class="divide-y divide-gray-200">`;
                snapshot.forEach(doc => {
                    const student = doc.data();
                    const studentId = doc.id;
                    let accessInfo = '';
                    
                    if (student.accessType === 'link') {
                        const uploadUrl = `${window.location.origin}${window.location.pathname}#/upload/${gradId}/${student.uniqueLinkId}`;
                        accessInfo = `
                            <div class="mt-2">
                                <p class="text-xs text-gray-500 mb-1">Unique Link:</p>
                                <div class="flex rounded-md shadow-sm mb-1">
                                    <input type="text" readonly value="${uploadUrl}" class="flex-1 block w-full rounded-none rounded-l-md text-xs border-gray-300 bg-gray-50 p-1 text-indigo-600">
                                    <button onclick="copyToClipboard('${uploadUrl}', this)" class="inline-flex items-center px-2 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-xs hover:bg-gray-100">Copy</button>
                                </div>
                                <a href="${uploadUrl}" target="_blank" class="text-xs text-indigo-600 hover:text-indigo-800 underline">→ Open link in new tab</a>
                            </div>
                        `;
                    } else if (student.accessType === 'password') {
                        accessInfo = `
                            <div class="mt-2">
                                <p class="text-xs text-gray-500">Password: <span class="font-mono font-bold text-green-600">${student.passwordPlain || 'N/A'}</span></p>
                                <p class="text-xs text-blue-600">Use general upload link above</p>
                            </div>
                        `;
                    } else if (student.accessType === 'public') {
                        accessInfo = `<p class="text-xs text-blue-600 mt-1">Use general upload link above</p>`;
                    }
                    
                    // Upload button for teachers
                    const uploadSection = student.profilePdfUrl 
                        ? `<div class="text-right">
                             <a href="${ensurePublicPdfUrl(student.profilePdfUrl)}" target="_blank" class="text-sm text-green-600 font-medium">✓ PDF Uploaded</a>
                             <button onclick="uploadPdfForStudent('${studentId}', '${student.name}', '${gradId}')" class="ml-2 text-xs text-blue-600 hover:text-blue-800 underline">Replace PDF</button>
                             <button onclick="removePdfForStudent('${studentId}', '${student.name}', '${gradId}')" class="ml-2 text-xs text-red-600 hover:text-red-800 underline">Remove PDF</button>
                           </div>` 
                        : `<div class="text-right">
                             <span class="text-sm text-orange-500">⏳ No PDF</span>
                             <button onclick="uploadPdfForStudent('${studentId}', '${student.name}', '${gradId}')" class="ml-2 px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Upload PDF</button>
                           </div>`;
                    
                    html += `
                        <li class="py-4 flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <p class="text-md font-medium text-gray-800">${student.name}</p>
                                    ${uploadSection}
                                </div>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="inline-block px-2 py-1 text-xs font-medium rounded-full ${
                                        student.accessType === 'public' ? 'bg-blue-100 text-blue-800' :
                                        student.accessType === 'password' ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-green-100 text-green-800'
                                    }">${
                                        student.accessType === 'public' ? 'Public Access' :
                                        student.accessType === 'password' ? 'Password Protected' :
                                        'Unique Link'
                                    }</span>
                                </div>
                                ${accessInfo}
                            </div>
                            <button onclick="deleteStudent('${studentId}', '${student.name}', '${gradId}')" class="ml-4 px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 whitespace-nowrap">Delete Student</button>
                        </li>
                    `;
                });
                html += `</ul>`;
                studentListContainer.innerHTML = html;
            });
            
            // Setup student form handler
            const addStudentForm = document.getElementById('add-student-form');
            if (addStudentForm) {
                setupAddStudentFormHandler(addStudentForm, {
                    showModal,
                    sanitizeInput,
                    rateLimiter,
                    currentUser,
                    gradId,
                    router
                });
            }
            
            // Add copy functionality for general upload URL
            const copyBtn = document.getElementById('copy-general-url-btn');
            if (copyBtn) {
                setupCopyGeneralUrlHandler(copyBtn, copyToClipboard);
            }
        };
        
        const renderContentPagesTab = async (gradId) => {
            const contentContainer = document.getElementById('tab-content');
            
            contentContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Content Pages</h3>
                        <button id="add-content-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Add New Page</button>
                    </div>
                    
                    <div id="content-pages-list" class="space-y-4 mb-6">
                        <div class="flex items-center justify-center p-8 text-gray-500">
                            <div class="text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                                <p class="mt-2">No content pages yet</p>
                                <p class="text-sm">Add speeches, messages, or other custom content</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add/Edit Content Form -->
                    <div id="content-form" class="hidden bg-gray-50 p-6 rounded-lg border">
                        <h4 class="text-md font-medium text-gray-900 mb-4">Add/Edit Content Page</h4>
                        <form id="add-content-form" class="space-y-4">
                            <div>
                                <label for="content-title" class="block text-sm font-medium text-gray-700">Page Title</label>
                                <input type="text" id="content-title" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., Principal's Message, Class Memories">
                            </div>
                            
                            <div>
                                <label for="content-author" class="block text-sm font-medium text-gray-700">Author (Optional)</label>
                                <input type="text" id="content-author" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., Mrs. Smith, Class 6A">
                            </div>
                            
                            <div>
                                <label for="content-type" class="block text-sm font-medium text-gray-700">Content Type</label>
                                <select id="content-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="text">Text Content</option>
                                    <option value="speech">Speech/Message</option>
                                    <option value="memory">Class Memory</option>
                                    <option value="thanks">Thank You Note</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="content-body" class="block text-sm font-medium text-gray-700">Content</label>
                                <textarea id="content-body" rows="8" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Enter your content here..."></textarea>
                                <p class="mt-1 text-sm text-gray-500">You can use simple formatting: **bold**, *italic*, and line breaks</p>
                            </div>
                            
                            <div class="flex justify-end gap-4">
                                <button type="button" id="cancel-content-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Content</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            // Load existing content pages
            const loadContentPages = () => {
                ContentRepository.onUpdate(gradId, (snapshot) => {
                    const listContainer = document.getElementById('content-pages-list');
                    
                    if (snapshot.empty) {
                        listContainer.innerHTML = `
                            <div class="flex items-center justify-center p-8 text-gray-500">
                                <div class="text-center">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                    <p class="mt-2">No content pages yet</p>
                                    <p class="text-sm">Add speeches, messages, or other custom content</p>
                                </div>
                            </div>
                        `;
                        return;
                    }

                    let html = '<div class="space-y-4">';
                    snapshot.forEach(doc => {
                        const content = doc.data();
                        const preview = content.content.length > 100 ? content.content.substring(0, 100) + '...' : content.content;
                        
                        html += `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <h4 class="text-lg font-medium text-gray-900">${content.title}</h4>
                                        ${content.author ? `<p class="text-sm text-gray-600 mt-1">By: ${content.author}</p>` : ''}
                                        <span class="inline-block mt-2 px-2 py-1 text-xs font-medium rounded-full ${getContentTypeStyle(content.type)}">${getContentTypeLabel(content.type)}</span>
                                        <p class="mt-3 text-gray-700">${preview}</p>
                                    </div>
                                    <div class="flex gap-2 ml-4">
                                        <button onclick="editContentPage('${doc.id}', '${content.title}', '${content.author || ''}', '${content.type}', \`${content.content.replace(/`/g, '\\`')}\`)" class="text-indigo-600 hover:text-indigo-800 text-sm">Edit</button>
                                        <button onclick="deleteContentPage('${doc.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    listContainer.innerHTML = html;
                });
            };

            // Helper functions for content type styling
            window.getContentTypeStyle = (type) => {
                const styles = {
                    text: 'bg-blue-100 text-blue-800',
                    speech: 'bg-green-100 text-green-800', 
                    memory: 'bg-purple-100 text-purple-800',
                    thanks: 'bg-pink-100 text-pink-800'
                };
                return styles[type] || styles.text;
            };

            window.getContentTypeLabel = (type) => {
                const labels = {
                    text: 'Text Content',
                    speech: 'Speech/Message',
                    memory: 'Class Memory', 
                    thanks: 'Thank You Note'
                };
                return labels[type] || 'Content';
            };

            // Global functions for editing and deleting
            window.editContentPage = (id, title, author, type, content) => {
                document.getElementById('content-title').value = title;
                document.getElementById('content-author').value = author;
                document.getElementById('content-type').value = type;
                document.getElementById('content-body').value = content;
                document.getElementById('content-form').classList.remove('hidden');
                document.getElementById('add-content-form').dataset.editId = id;
            };

            window.deleteContentPage = async (id) => {
                if (confirm('Are you sure you want to delete this content page?')) {
                    try {
                        await ContentRepository.delete(gradId, id);
                        showModal('Success', 'Content page deleted successfully.');
                    } catch (error) {
                        console.error('Error deleting content page:', error);
                        showModal('Error', 'Failed to delete content page.');
                    }
                }
            };

            // Event listeners
            // Setup content handlers
            const addContentBtn = document.getElementById('add-content-btn');
            const cancelContentBtn = document.getElementById('cancel-content-btn');
            const addContentForm = document.getElementById('add-content-form');
            
            if (addContentBtn) setupAddContentHandler(addContentBtn);
            if (cancelContentBtn) setupCancelContentHandler(cancelContentBtn);
            if (addContentForm) {
                setupContentFormHandler(addContentForm, gradId, {
                    sanitizeInput,
                    showModal
                });
            }

            // Load content pages
            loadContentPages();
        };
        
        const renderSettingsTab = (gradId, config) => {
             const contentContainer = document.getElementById('tab-content');
             contentContainer.innerHTML = `
                 <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 mb-6">Website Settings</h3>
                     <form id="settings-form" class="space-y-6">
                        <div>
                            <label for="schoolLogo" class="block text-sm font-medium text-gray-700">School Logo</label>
                            <input type="file" id="schoolLogo" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            ${config.schoolLogoUrl ? `<img src="${config.schoolLogoUrl}" class="h-16 mt-2 rounded">` : ''}
                        </div>
                        
                        <div>
                            <label for="primaryColor" class="block text-sm font-medium text-gray-700">Primary Color</label>
                            <input type="color" id="primaryColor" value="${config.primaryColor || '#3B82F6'}" class="mt-1 h-10 w-full block border border-gray-300 rounded-md">
                        </div>
                        
                        <div>
                            <label for="font" class="block text-sm font-medium text-gray-700">Font Family</label>
                            <select id="font" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="Inter" ${config.font === 'Inter' ? 'selected' : ''}>Inter</option>
                                <option value="Roboto" ${config.font === 'Roboto' ? 'selected' : ''}>Roboto</option>
                                <option value="Arial" ${config.font === 'Arial' ? 'selected' : ''}>Arial</option>
                                <option value="Georgia" ${config.font === 'Georgia' ? 'selected' : ''}>Georgia</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="layout" class="block text-sm font-medium text-gray-700">Layout Style</label>
                            <select id="layout" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="grid" ${config.layout === 'grid' ? 'selected' : ''}>Grid Layout</option>
                                <option value="scroll" ${config.layout === 'scroll' ? 'selected' : ''}>Scroll Layout</option>
                                <option value="cards" ${config.layout === 'cards' ? 'selected' : ''}>Card Layout</option>
                                <option value="list" ${config.layout === 'list' ? 'selected' : ''}>List Layout</option>
                            </select>
                        </div>
                        
                        <!-- Advanced Theme Settings -->
                        <div class="border-t pt-6">
                            <h4 class="text-lg font-medium text-gray-900 mb-4">Advanced Theme Options</h4>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="secondaryColor" class="block text-sm font-medium text-gray-700">Secondary Color</label>
                                    <input type="color" id="secondaryColor" value="${config.secondaryColor || '#6B7280'}" class="mt-1 h-10 w-full block border border-gray-300 rounded-md">
                                    <p class="mt-1 text-sm text-gray-500">Used for secondary text and accents</p>
                                </div>
                                
                                <div>
                                    <label for="backgroundColor" class="block text-sm font-medium text-gray-700">Background Color</label>
                                    <input type="color" id="backgroundColor" value="${config.backgroundColor || '#F9FAFB'}" class="mt-1 h-10 w-full block border border-gray-300 rounded-md">
                                    <p class="mt-1 text-sm text-gray-500">Main background color</p>
                                </div>
                                
                                <div>
                                    <label for="cardStyle" class="block text-sm font-medium text-gray-700">Card Style</label>
                                    <select id="cardStyle" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                        <option value="shadow" ${config.cardStyle === 'shadow' ? 'selected' : ''}>Drop Shadow</option>
                                        <option value="border" ${config.cardStyle === 'border' ? 'selected' : ''}>Border Only</option>
                                        <option value="elevated" ${config.cardStyle === 'elevated' ? 'selected' : ''}>Elevated</option>
                                        <option value="minimal" ${config.cardStyle === 'minimal' ? 'selected' : ''}>Minimal</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="borderRadius" class="block text-sm font-medium text-gray-700">Border Radius</label>
                                    <select id="borderRadius" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                        <option value="none" ${config.borderRadius === 'none' ? 'selected' : ''}>None (0px)</option>
                                        <option value="small" ${config.borderRadius === 'small' ? 'selected' : ''}>Small (4px)</option>
                                        <option value="medium" ${config.borderRadius === 'medium' ? 'selected' : ''}>Medium (8px)</option>
                                        <option value="large" ${config.borderRadius === 'large' ? 'selected' : ''}>Large (12px)</option>
                                        <option value="full" ${config.borderRadius === 'full' ? 'selected' : ''}>Rounded (50px)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="headerStyle" class="block text-sm font-medium text-gray-700">Header Style</label>
                                    <select id="headerStyle" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                        <option value="centered" ${config.headerStyle === 'centered' ? 'selected' : ''}>Centered</option>
                                        <option value="left" ${config.headerStyle === 'left' ? 'selected' : ''}>Left Aligned</option>
                                        <option value="banner" ${config.headerStyle === 'banner' ? 'selected' : ''}>Full Banner</option>
                                        <option value="minimal" ${config.headerStyle === 'minimal' ? 'selected' : ''}>Minimal</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="animationStyle" class="block text-sm font-medium text-gray-700">Animation Style</label>
                                    <select id="animationStyle" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                        <option value="none" ${config.animationStyle === 'none' ? 'selected' : ''}>No Animation</option>
                                        <option value="fade" ${config.animationStyle === 'fade' ? 'selected' : ''}>Fade In</option>
                                        <option value="slide" ${config.animationStyle === 'slide' ? 'selected' : ''}>Slide In</option>
                                        <option value="bounce" ${config.animationStyle === 'bounce' ? 'selected' : ''}>Bounce In</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <label class="block text-sm font-medium text-gray-700">Content Visibility</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="showSpeeches" ${config.showSpeeches !== false ? 'checked' : ''} class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Show Speeches Section</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="showMessages" ${config.showMessages !== false ? 'checked' : ''} class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Show Messages Section</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Download Scheduling -->
                        <div class="border-t pt-6">
                            <h4 class="text-lg font-medium text-gray-900 mb-4">Download Settings</h4>
                            
                            <div class="space-y-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="enableDownloadScheduling" ${config.enableDownloadScheduling ? 'checked' : ''} class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Schedule PDF booklet availability</span>
                                </label>
                                
                                <div id="download-scheduling" class="ml-6 space-y-4 ${config.enableDownloadScheduling ? '' : 'hidden'}">
                                    <div>
                                        <label for="downloadAvailableDate" class="block text-sm font-medium text-gray-700">Make booklet available on</label>
                                        <input type="datetime-local" id="downloadAvailableDate" value="${config.downloadableAfterDate ? new Date(config.downloadableAfterDate).toISOString().slice(0, 16) : ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <p class="mt-1 text-sm text-gray-500">Students and parents will only be able to download the booklet after this date</p>
                                    </div>
                                    
                                    <div>
                                        <label for="downloadMessage" class="block text-sm font-medium text-gray-700">Message before availability (Optional)</label>
                                        <textarea id="downloadMessage" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., The graduation booklet will be available after the ceremony...">${config.downloadMessage || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Page Order</label>
                            <div id="page-order" class="space-y-2">
                                ${(config.pageOrder || ['students', 'messages', 'speeches']).map((page, index) => `
                                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                                        <span class="capitalize">${page}</span>
                                        <div class="space-x-2">
                                            <button type="button" onclick="movePageUp(${index})" class="text-blue-600 hover:text-blue-800" ${index === 0 ? 'disabled' : ''}>↑</button>
                                            <button type="button" onclick="movePageDown(${index})" class="text-blue-600 hover:text-blue-800" ${index === (config.pageOrder || ['students', 'messages', 'speeches']).length - 1 ? 'disabled' : ''}>↓</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Settings</button>
                        </div>
                    </form>
                 </div>
             `;

             // Add page order management functions to window for onclick handlers
             window.movePageUp = (index) => {
                 const orderElements = document.querySelectorAll('#page-order > div');
                 if (index > 0) {
                     const currentOrder = Array.from(orderElements).map(el => el.querySelector('span').textContent);
                     [currentOrder[index], currentOrder[index - 1]] = [currentOrder[index - 1], currentOrder[index]];
                     updatePageOrderDisplay(currentOrder);
                 }
             };
             
             window.movePageDown = (index) => {
                 const orderElements = document.querySelectorAll('#page-order > div');
                 if (index < orderElements.length - 1) {
                     const currentOrder = Array.from(orderElements).map(el => el.querySelector('span').textContent);
                     [currentOrder[index], currentOrder[index + 1]] = [currentOrder[index + 1], currentOrder[index]];
                     updatePageOrderDisplay(currentOrder);
                 }
             };
             
             const updatePageOrderDisplay = (order) => {
                 const container = document.getElementById('page-order');
                 container.innerHTML = order.map((page, index) => `
                     <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                         <span class="capitalize">${page}</span>
                         <div class="space-x-2">
                             <button type="button" onclick="movePageUp(${index})" class="text-blue-600 hover:text-blue-800" ${index === 0 ? 'disabled' : ''}>↑</button>
                             <button type="button" onclick="movePageDown(${index})" class="text-blue-600 hover:text-blue-800" ${index === order.length - 1 ? 'disabled' : ''}>↓</button>
                         </div>
                     </div>
                 `).join('');
             };

             // Add download scheduling toggle handler
             document.getElementById('enableDownloadScheduling').addEventListener('change', (e) => {
                 const schedulingDiv = document.getElementById('download-scheduling');
                 if (e.target.checked) {
                     schedulingDiv.classList.remove('hidden');
                 } else {
                     schedulingDiv.classList.add('hidden');
                 }
             });

             document.getElementById('settings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                showModal('Saving...', 'Updating your settings.', false);
                
                // Basic settings
                const color = document.getElementById('primaryColor').value;
                const font = document.getElementById('font').value;
                const layout = document.getElementById('layout').value;
                const showSpeeches = document.getElementById('showSpeeches').checked;
                const showMessages = document.getElementById('showMessages').checked;
                const logoFile = document.getElementById('schoolLogo').files[0];
                
                // Advanced theme settings
                const secondaryColor = document.getElementById('secondaryColor').value;
                const backgroundColor = document.getElementById('backgroundColor').value;
                const cardStyle = document.getElementById('cardStyle').value;
                const borderRadius = document.getElementById('borderRadius').value;
                const headerStyle = document.getElementById('headerStyle').value;
                const animationStyle = document.getElementById('animationStyle').value;
                
                // Download scheduling settings
                const enableDownloadScheduling = document.getElementById('enableDownloadScheduling').checked;
                const downloadAvailableDate = document.getElementById('downloadAvailableDate').value;
                const downloadMessage = document.getElementById('downloadMessage').value;
                
                // Get current page order
                const orderElements = document.querySelectorAll('#page-order > div');
                const pageOrder = Array.from(orderElements).map(el => el.querySelector('span').textContent);
                
                let logoUrl = config.schoolLogoUrl;

                if (logoFile) {
                    if (CLOUDINARY_CLOUD_NAME === "YOUR_CLOUD_NAME") {
                        showModal("Configuration Needed", "Please set up your Cloudinary details in the HTML file to upload a logo.");
                        return;
                    }
                    try {
                        logoUrl = await uploadFile(logoFile);
                    } catch (error) {
                        showModal('Error', `Failed to upload logo: ${error.message}`);
                        return;
                    }
                }

                const newConfig = {
                    ...config,
                    // Basic settings
                    primaryColor: color,
                    font: font,
                    layout: layout,
                    showSpeeches: showSpeeches,
                    showMessages: showMessages,
                    pageOrder: pageOrder,
                    schoolLogoUrl: logoUrl,
                    
                    // Advanced theme settings
                    secondaryColor: secondaryColor,
                    backgroundColor: backgroundColor,
                    cardStyle: cardStyle,
                    borderRadius: borderRadius,
                    headerStyle: headerStyle,
                    animationStyle: animationStyle,
                    
                    // Download scheduling
                    enableDownloadScheduling: enableDownloadScheduling,
                    downloadableAfterDate: enableDownloadScheduling && downloadAvailableDate ? new Date(downloadAvailableDate) : null,
                    downloadMessage: enableDownloadScheduling ? downloadMessage : null,
                    
                    // Metadata
                    updatedAt: new Date()
                };

                await GraduationRepository.updateConfig(gradId, newConfig);
                showModal('Saved!', 'Your settings have been updated.');
                // Trigger a re-render of the editor to show the new logo
                router(); 
             });
        };

        const renderShareTab = (publicUrl) => {
            const contentContainer = document.getElementById('tab-content');
            contentContainer.innerHTML = `
                 <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Share Your Website</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Public URL</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="text" readonly id="public-url-input" value="${publicUrl}" class="flex-1 block w-full rounded-none rounded-l-md sm:text-sm border-gray-300 bg-gray-50 p-2">
                                <button id="copy-url-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">Copy</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">QR Code</label>
                            <div id="qrcode" class="mt-2 p-4 bg-white inline-block border rounded-md"></div>
                        </div>
                         <a href="${publicUrl}" target="_blank" class="inline-block mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Open Public Site</a>
                    </div>
                </div>
            `;
            new QRCode(document.getElementById("qrcode"), {
                text: publicUrl,
                width: 128,
                height: 128,
            });
            document.getElementById('copy-url-btn').addEventListener('click', () => {
                const input = document.getElementById('public-url-input');
                input.select();
                document.execCommand('copy');
                showModal('Copied!', 'The URL has been copied to your clipboard.');
            });
        };
        
        const renderBookletTab = (gradId, gradData) => {
            const contentContainer = document.getElementById('tab-content');
            const config = gradData.config || {};
            
            // Check if download is scheduled and available
            const isScheduled = config.enableDownloadScheduling && config.downloadableAfterDate;
            const isAvailable = !isScheduled || new Date() >= new Date(config.downloadableAfterDate);
            
            // Add fl_attachment flag to force download instead of viewing in browser
            const getDownloadUrl = (url) => {
                if (!url) return url;
                // If URL doesn't already have fl_attachment, add it
                if (!url.includes('fl_attachment')) {
                    return url.replace('/upload/', '/upload/fl_attachment/');
                }
                return url;
            };
            
            const downloadUrl = getDownloadUrl(gradData.generatedBookletUrl);
            
            let bookletInfo = `
                <p class="text-gray-600 mb-4">Click the button to combine all uploaded student PDFs into a single downloadable booklet.</p>
                <button id="generate-booklet-btn" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Generate Booklet</button>
            `;
            
            if (gradData.generatedBookletUrl) {
                if (isScheduled) {
                    if (isAvailable) {
                        bookletInfo = `
                            <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-md">
                                <div class="flex">
                                    <svg class="h-5 w-5 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-green-800">Booklet Available</h3>
                                        <p class="text-sm text-green-700">The graduation booklet is now available for download.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <a href="${downloadUrl}" download="graduation-booklet.pdf" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Download Booklet</a>
                                <button id="generate-booklet-btn" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Re-generate Booklet</button>
                            </div>
                        `;
                    } else {
                        const availableDate = new Date(config.downloadableAfterDate);
                        bookletInfo = `
                            <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-md">
                                <div class="flex">
                                    <svg class="h-5 w-5 text-yellow-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-yellow-800">Booklet Scheduled</h3>
                                        <p class="text-sm text-yellow-700">
                                            The booklet will be available for download on 
                                            <strong>${availableDate.toLocaleDateString()} at ${availableDate.toLocaleTimeString()}</strong>
                                        </p>
                                        ${config.downloadMessage ? `<p class="text-sm text-yellow-700 mt-2">${config.downloadMessage}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <button disabled class="px-6 py-2 bg-gray-400 text-white rounded-md cursor-not-allowed">Download Not Yet Available</button>
                                <button id="generate-booklet-btn" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Re-generate Booklet</button>
                            </div>
                        `;
                    }
                } else {
                    bookletInfo = `
                        <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-md">
                            <div class="flex">
                                <svg class="h-5 w-5 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-green-800">Booklet Generated</h3>
                                    <p class="text-sm text-green-700">Your graduation booklet is ready for download.</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <a href="${downloadUrl}" download="graduation-booklet.pdf" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Download Booklet</a>
                            <button id="generate-booklet-btn" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Re-generate Booklet</button>
                        </div>
                    `;
                }
            }
            
            contentContainer.innerHTML = `
                 <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 mb-2">Graduation Booklet</h3>
                    ${bookletInfo}
                    
                    ${isScheduled ? `
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h4 class="text-md font-medium text-gray-900 mb-2">Download Settings</h4>
                            <div class="text-sm text-gray-600">
                                <p><strong>Scheduled Release:</strong> ${new Date(config.downloadableAfterDate).toLocaleString()}</p>
                                ${config.downloadMessage ? `<p class="mt-2"><strong>Message:</strong> ${config.downloadMessage}</p>` : ''}
                                <p class="mt-2 text-xs text-gray-500">You can change these settings in the Settings tab.</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            if (document.getElementById('generate-booklet-btn')) {
                document.getElementById('generate-booklet-btn').addEventListener('click', () => generateBookletWithUI(gradId));
            }
        };
        
        const renderPublicView = async (gradData, students, gradId) => {
             const { config } = gradData;
             const fontFamily = config.font || 'Inter';
             const layoutClass = config.layout === 'scroll' ? 'space-y-8' : 
                               config.layout === 'cards' ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' :
                               config.layout === 'list' ? 'space-y-4' :
                               'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6';
             
             // Get border radius class
             const borderRadiusClass = {
                 'none': 'rounded-none',
                 'small': 'rounded',
                 'medium': 'rounded-lg', 
                 'large': 'rounded-xl',
                 'full': 'rounded-full'
             }[config.borderRadius] || 'rounded-lg';
             
             // Get card style classes
             const cardStyleClass = {
                 'shadow': 'shadow-md hover:shadow-lg transition-shadow',
                 'border': 'border border-gray-200',
                 'elevated': 'shadow-lg transform hover:scale-105 transition-all',
                 'minimal': 'bg-transparent'
             }[config.cardStyle] || 'shadow-md';
             
             // Get animation classes
             const animationClass = {
                 'fade': 'animate-fade-in',
                 'slide': 'animate-slide-in',
                 'bounce': 'animate-bounce-in',
                 'none': ''
             }[config.animationStyle] || '';
             
             // Fetch content pages
             const contentPages = await ContentRepository.getAll(gradId);
             
             // Sort content pages by creation date
             contentPages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
             
             appContainer.innerHTML = `
                <style>
                    .animate-fade-in { animation: fadeIn 0.6s ease-in; }
                    .animate-slide-in { animation: slideIn 0.8s ease-out; }
                    .animate-bounce-in { animation: bounceIn 1s ease-out; }
                    
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes slideIn {
                        from { transform: translateY(30px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    
                    @keyframes bounceIn {
                        0% { transform: scale(0.3); opacity: 0; }
                        50% { transform: scale(1.05); }
                        70% { transform: scale(0.9); }
                        100% { transform: scale(1); opacity: 1; }
                    }
                </style>
                <div class="min-h-screen ${animationClass}" style="font-family: '${fontFamily}', sans-serif; background-color: ${config.backgroundColor || '#F9FAFB'};">
                    <div class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
                        <header class="my-12 ${config.headerStyle === 'left' ? 'text-left' : config.headerStyle === 'banner' ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white p-8 rounded-xl text-center' : config.headerStyle === 'minimal' ? 'text-center py-4' : 'text-center'}">
                             ${config.schoolLogoUrl ? `<img src="${config.schoolLogoUrl}" class="h-24 ${config.headerStyle === 'left' ? '' : 'mx-auto'} mb-4 ${borderRadiusClass}">` : ''}
                            <h1 class="text-4xl font-bold ${config.headerStyle === 'banner' ? 'text-white' : ''}" style="color: ${config.headerStyle === 'banner' ? 'white' : config.primaryColor};">${gradData.schoolName}</h1>
                            <p class="text-2xl ${config.headerStyle === 'banner' ? 'text-blue-100' : 'text-gray-600'} mt-2">Class of ${gradData.graduationYear}</p>
                        </header>
                        
                        <main class="space-y-12">
                            ${(config.pageOrder || ['students', 'messages', 'speeches']).map(section => {
                                if (section === 'students') {
                                    return `
                                        <section class="${animationClass}">
                                            <h2 class="text-3xl font-bold text-center mb-8" style="color: ${config.primaryColor};">Our Graduates</h2>
                                            <div class="${layoutClass}">
                                                ${students.map(s => `
                                                    <div class="text-center ${config.layout === 'scroll' || config.layout === 'list' ? `p-6 bg-white ${cardStyleClass} ${borderRadiusClass}` : config.layout === 'cards' ? `bg-white ${cardStyleClass} ${borderRadiusClass} p-4` : ''} ${s.profilePdfUrl ? 'cursor-pointer hover:opacity-80 transition-opacity' : ''}" 
                                                         ${s.profilePdfUrl ? `onclick="viewStudentPdf('${ensurePublicPdfUrl(s.profilePdfUrl)}', '${s.name}')"` : ''}>
                                                        <div class="w-32 h-32 bg-gray-200 ${borderRadiusClass} mx-auto flex items-center justify-center mb-2" style="background-color: ${config.secondaryColor}20;">
                                                            <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                                        </div>
                                                        <h3 class="font-semibold text-gray-800">${s.name}</h3>
                                                        ${s.profilePdfUrl ? `<span class="text-sm hover:underline transition-colors" style="color: ${config.primaryColor};">View Profile</span>` : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </section>
                                    `;
                                } else if (section === 'messages' && config.showMessages !== false) {
                                    const messagePages = contentPages.filter(p => p.type === 'thanks' || p.type === 'memory');
                                    return `
                                        <section class="${animationClass}">
                                            <h2 class="text-3xl font-bold text-center mb-8" style="color: ${config.primaryColor};">Messages & Memories</h2>
                                            ${messagePages.length > 0 ? `
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    ${messagePages.map(page => `
                                                        <div class="bg-white ${cardStyleClass} ${borderRadiusClass} p-6">
                                                            <h3 class="text-xl font-semibold mb-2" style="color: ${config.primaryColor};">${page.title}</h3>
                                                            ${page.author ? `<p class="text-sm text-gray-600 mb-4">By: ${page.author}</p>` : ''}
                                                            <div class="prose prose-sm">${page.content.replace(/\n/g, '<br>')}</div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            ` : `
                                                <div class="bg-white ${cardStyleClass} ${borderRadiusClass} p-8 text-center">
                                                    <p style="color: ${config.secondaryColor};">Messages and memories will appear here.</p>
                                                </div>
                                            `}
                                        </section>
                                    `;
                                } else if (section === 'speeches' && config.showSpeeches !== false) {
                                    const speechPages = contentPages.filter(p => p.type === 'speech' || p.type === 'text');
                                    return `
                                        <section class="${animationClass}">
                                            <h2 class="text-3xl font-bold text-center mb-8" style="color: ${config.primaryColor};">Speeches & Presentations</h2>
                                            ${speechPages.length > 0 ? `
                                                <div class="space-y-6">
                                                    ${speechPages.map(page => `
                                                        <div class="bg-white ${cardStyleClass} ${borderRadiusClass} p-8">
                                                            <h3 class="text-2xl font-bold mb-4" style="color: ${config.primaryColor};">${page.title}</h3>
                                                            ${page.author ? `<p class="text-gray-600 mb-6 italic">By: ${page.author}</p>` : ''}
                                                            <div class="prose prose-lg max-w-none">${page.content.replace(/\n/g, '<br>')}</div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            ` : `
                                                <div class="bg-white ${cardStyleClass} ${borderRadiusClass} p-8 text-center">
                                                    <p style="color: ${config.secondaryColor};">Graduation speeches will appear here.</p>
                                                </div>
                                            `}
                                        </section>
                                    `;
                                }
                                return '';
                            }).filter(Boolean).join('')}
                        </main>
                    </div>
                </div>
             `;
        };

        const renderStudentUploadPortal = (gradId, students) => {
            // Combine all students for single dropdown
            const allStudents = students.filter(s => s.accessType === 'public' || s.accessType === 'password');
            
            appContainer.innerHTML = `
                 <div class="min-h-screen bg-gray-100 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
                    <div class="sm:mx-auto sm:w-full sm:max-w-xl">
                        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                            Student PDF Upload
                        </h2>
                        <p class="mt-2 text-center text-sm text-gray-600">
                            Select your name from the list below to upload your graduation PDF
                        </p>
                    </div>

                    <div id="student-selector" class="mt-8 sm:mx-auto sm:w-full sm:max-w-xl bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10 space-y-4">
                        ${allStudents.length > 0 ? `
                        <div>
                            <label for="student-select" class="block text-sm font-medium text-gray-700">Select Your Name</label>
                            <select id="student-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">-- Please select your name --</option>
                                ${allStudents.map(s => {
                                    const label = s.accessType === 'password' ? `${s.name} 🔒` : s.name;
                                    return `<option value="${s.id}" data-access-type="${s.accessType}">${label}</option>`;
                                }).join('')}
                            </select>
                        </div>
                        
                        <div id="password-area" class="hidden">
                            <label for="student-password" class="block text-sm font-medium text-gray-700">Enter Your Password</label>
                            <input type="password" id="student-password" placeholder="Enter the password provided by your teacher" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <button id="verify-password-btn" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Verify Password</button>
                        </div>
                        
                         <div id="upload-area" class="hidden">
                            <label for="pdf-upload" class="block text-sm font-medium text-gray-700">Upload Your PDF Profile</label>
                            <p class="text-xs text-gray-500 mt-1">Please upload your graduation profile as a PDF (max 10MB)</p>
                            <input type="file" id="pdf-upload" accept=".pdf" class="mt-2 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <button id="submit-pdf-btn" class="mt-4 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Upload PDF</button>
                        </div>
                        ` : `
                        <div class="text-center text-gray-500">
                            <p>No students available for upload. Please check with your teacher.</p>
                        </div>
                        `}
                    </div>
                 </div>
            `;

            let selectedStudentId = null;
            let selectedStudentData = null;

            // Handle unified student selection
            if (allStudents.length > 0) {
                document.getElementById('student-select').addEventListener('change', (e) => {
                    const studentId = e.target.value;
                    const selectedOption = e.target.selectedOptions[0];
                    const accessType = selectedOption?.getAttribute('data-access-type');
                    
                    // Reset areas
                    document.getElementById('password-area').classList.add('hidden');
                    document.getElementById('upload-area').classList.add('hidden');
                    selectedStudentId = null;
                    selectedStudentData = null;
                    
                    if (studentId) {
                        selectedStudentData = allStudents.find(s => s.id === studentId);
                        
                        if (accessType === 'password') {
                            // Show password area for password-protected students
                            document.getElementById('password-area').classList.remove('hidden');
                            document.getElementById('student-password').value = ''; // Clear password field
                        } else {
                            // Show upload area directly for public students
                            selectedStudentId = studentId;
                            document.getElementById('upload-area').classList.remove('hidden');
                        }
                    }
                });

                // Handle password verification
                document.getElementById('verify-password-btn').addEventListener('click', async () => {
                    const password = document.getElementById('student-password').value;
                    
                    if (!selectedStudentData || !password) {
                        showModal('Error', 'Please enter the password.');
                        return;
                    }

                    // Rate limiting for password attempts
                    const rateLimitKey = `password-verify-${selectedStudentData.id}`;
                    if (!rateLimiter.isAllowed(rateLimitKey, 3, 300000)) { // 3 attempts per 5 minutes
                        showModal('Rate Limit', 'Too many password attempts. Please wait 5 minutes before trying again.');
                        return;
                    }

                    try {
                        showModal('Verifying...', 'Checking your password.', false);
                        
                        const isValid = await verifyStudentPassword(gradId, selectedStudentData.id, password);
                        
                        if (isValid) {
                            selectedStudentId = selectedStudentData.id;
                            document.getElementById('upload-area').classList.remove('hidden');
                            rateLimiter.reset(rateLimitKey); // Reset on successful verification
                            showModal('Success', 'Password verified! You can now upload your PDF.');
                        } else {
                            showModal('Error', 'Incorrect password. Please try again.');
                        }
                    } catch (error) {
                        console.error('Password verification error:', error);
                        showModal('Error', 'Failed to verify password. Please try again.');
                    }
                });
            }

             document.getElementById('submit-pdf-btn').addEventListener('click', async () => {
                if (!selectedStudentId) {
                    showModal('Error', 'Please select your name first.');
                    return;
                }
                const file = document.getElementById('pdf-upload').files[0];
                if (!file) {
                    showModal('Error', 'Please select a PDF file to upload.');
                    return;
                }
                
                if (CLOUDINARY_CLOUD_NAME === "YOUR_CLOUD_NAME") {
                    showModal("Configuration Needed", "This feature is disabled until the app is configured with Cloudinary details.");
                    return;
                }

                try {
                    showModal('Uploading...', 'Your file is being uploaded.', false);
                    const pdfUrl = await uploadFile(file);

                    if (pdfUrl) {
                        await StudentRepository.updateProfilePdf(gradId, selectedStudentId, pdfUrl);
                        showModal('Success!', 'Your PDF has been uploaded successfully. You can now close this page.');
                    }
                } catch (error) {
                    console.error('PDF upload error:', error);
                    showModal('Upload Failed', error.message || 'Failed to upload PDF. Please try again.');
                }
             });
        };
        
        const renderDirectUpload = (gradId, student) => {
            appContainer.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
                    <div class="sm:mx-auto sm:w-full sm:max-w-xl">
                        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                            PDF Upload for ${student.name}
                        </h2>
                    </div>

                    <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-xl bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10 space-y-4">
                        <div class="text-center mb-4">
                            <p class="text-lg font-medium text-gray-700">Welcome, ${student.name}!</p>
                            <p class="text-sm text-gray-500">Upload your PDF profile using the form below.</p>
                        </div>
                        
                        <div>
                            <label for="pdf-upload" class="block text-sm font-medium text-gray-700">Upload Your PDF Profile</label>
                            <input type="file" id="pdf-upload" accept=".pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <button id="submit-pdf-btn" class="mt-4 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Upload PDF</button>
                        </div>
                        
                        ${student.profilePdfUrl ? `
                        <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-md">
                            <p class="text-sm text-green-700">✓ You have already uploaded a PDF. Uploading a new one will replace the previous file.</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.getElementById('submit-pdf-btn').addEventListener('click', async () => {
                const file = document.getElementById('pdf-upload').files[0];
                if (!file) {
                    showModal('Error', 'Please select a PDF file to upload.');
                    return;
                }
                
                if (CLOUDINARY_CLOUD_NAME === "YOUR_CLOUD_NAME") {
                    showModal("Configuration Needed", "This feature is disabled until the app is configured with Cloudinary details.");
                    return;
                }

                try {
                    showModal('Uploading...', 'Your file is being uploaded.', false);
                    const pdfUrl = await uploadFile(file);

                    if (pdfUrl) {
                        await StudentRepository.updateProfilePdf(gradId, student.id, pdfUrl);
                        showModal('Success!', 'Your PDF has been uploaded successfully. You can now close this page.');
                    }
                } catch (error) {
                    console.error('PDF upload error:', error);
                    showModal('Upload Failed', error.message || 'Failed to upload PDF. Please try again.');
                }
            });
        };
        
        // Modal functions are now imported from js/components/modal.js

        // --- ROUTING ---
        // Router functions now created from router module
        const currentGraduationListener = { current: null };
        
        const router = createRouter({
            renderLoading: () => renderLoading(appContainer),
            renderLoginPage: renderLoginPageWithListeners,
            renderDashboard,
            renderNewGraduationForm,
            renderEditor,
            currentUser,
            currentGraduationListener
        });
        
        const publicRouter = createPublicRouter({
            renderLoading: () => renderLoading(appContainer),
            renderLoginPage: renderLoginPageWithListeners,
            renderPublicView,
            renderStudentUploadPortal,
            renderDirectUpload,
            showModal,
            currentUser,
            router
        });

        // --- INITIALIZATION ---
        onAuthStateChanged(auth, user => {
            currentUser = user;

            if (isPublicRoute()) {
                publicRouter();
            } else {
                if (user) {
                    if(!window.location.hash || window.location.hash === '#/') {
                        goToDashboard();
                    } else {
                        router();
                    }
                } else {
                    renderLoginPageWithListeners();
                }
            }
        });

        window.addEventListener('hashchange', () => {
            if (isPublicRoute()) {
                publicRouter();
            } else {
                router();
            }
        });

    </script>
</body>
</html>

